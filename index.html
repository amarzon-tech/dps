<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dialysis Diner: Plate Smart</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --muted:#93a4c7; --text:#eaf0ff;
      --accent:#5eead4; --warn:#fbbf24; --bad:#fb7185; --good:#86efac;
      --btn:#1b2a52; --btn2:#172447; --border:rgba(255,255,255,.12);
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); background:radial-gradient(1200px 700px at 30% 10%, #162852 0%, var(--bg) 60%);
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .app{width:min(980px, 100%); display:grid; gap:14px;}
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--border); background:rgba(16,26,51,.7);
      border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand .title{font-size:18px; font-weight:800; letter-spacing:.3px;}
    .brand .sub{font-size:12px; color:var(--muted)}
    .stats{display:flex; gap:14px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .pill{
      border:1px solid var(--border); background:rgba(9,14,28,.45);
      border-radius:999px; padding:8px 10px; font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text); font-weight:800}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;}
    @media (max-width: 880px){ .grid{grid-template-columns:1fr} .stats{justify-content:flex-start}}
    .card{
      border:1px solid var(--border); background:rgba(16,26,51,.72);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;
      backdrop-filter: blur(10px);
    }
    .mealName{
      font-size:26px; font-weight:900; line-height:1.15; margin:0 0 10px 0;
    }
    .mealMeta{display:flex; gap:8px; flex-wrap:wrap; margin:0 0 8px 0;}
    .chip{
      font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid var(--border);
      color:var(--muted); background:rgba(9,14,28,.45);
    }
    .chip.good{color:var(--good); border-color:rgba(134,239,172,.35)}
    .chip.warn{color:var(--warn); border-color:rgba(251,191,36,.35)}
    .chip.bad{color:var(--bad); border-color:rgba(251,113,133,.35)}
    .controls{display:grid; gap:10px; margin-top:12px;}
    .btnRow{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;}
    @media (max-width:520px){ .btnRow{grid-template-columns:1fr} }
    button{
      appearance:none; border:1px solid var(--border); background:var(--btn); color:var(--text);
      padding:12px 12px; border-radius:16px; font-weight:800; cursor:pointer;
      transition: transform .06s ease, filter .12s ease, background .12s ease;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform:scale(.99)}
    .toggleBtn.on{outline:2px solid rgba(94,234,212,.35); background:rgba(94,234,212,.12)}
    .primary{background:linear-gradient(135deg, rgba(94,234,212,.22), rgba(94,234,212,.08)); border-color:rgba(94,234,212,.35)}
    .danger{background:linear-gradient(135deg, rgba(251,113,133,.22), rgba(251,113,133,.08)); border-color:rgba(251,113,133,.35)}
    .muted{background:var(--btn2)}
    .sectionTitle{font-size:13px; color:var(--muted); font-weight:900; letter-spacing:.3px; text-transform:uppercase; margin:0 0 10px 0;}
    .sideGrid{display:grid; gap:12px;}
    .small{
      font-size:12px; color:var(--muted); line-height:1.4;
    }
    .line{height:1px; background:var(--border); margin:12px 0}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .row label{font-size:12px; color:var(--muted); font-weight:800}
    input[type="text"]{
      width:100%; padding:12px 12px; border-radius:16px; border:1px solid var(--border);
      background:rgba(9,14,28,.45); color:var(--text); font-weight:800;
    }
    .feedbackOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .feedbackBox{
      width:min(720px, 100%); border:1px solid var(--border);
      background:rgba(16,26,51,.92); border-radius:24px; box-shadow:var(--shadow);
      padding:18px; backdrop-filter: blur(10px);
    }
    .feedbackTitle{margin:0 0 8px 0; font-size:18px; font-weight:900}
    .feedbackText{margin:0; color:var(--text); line-height:1.45}
    .feedbackHint{margin-top:10px; color:var(--muted); font-size:12px}
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      border:1px solid rgba(94,234,212,.35); background:rgba(94,234,212,.12); color:var(--text);
      font-size:12px; font-weight:900;
    }
    .kbd{
      font-size:11px; padding:3px 7px; border:1px solid var(--border); border-radius:8px;
      background:rgba(9,14,28,.5); color:var(--muted); font-weight:900;
    }
  </style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <div class="brand">
      <div class="title">Dialysis Diner: Plate Smart</div>
      <div class="sub">Earn points for spotting Phos/K/Na traps, choosing protein wisely, and timing binders.</div>
    </div>
    <div class="stats">
      <div class="pill">üë§ <b id="nickPill">‚Äî</b></div>
      <div class="pill">‚≠ê Total <b id="totalScorePill">0</b></div>
      <div class="pill">üî• Streak <b id="streakPill">0</b></div>
      <div class="pill">üèÜ Best <b id="bestStreakPill">0</b></div>
    </div>
  </div>

  <div class="grid">
    <!-- Main gameplay -->
    <div class="card">
      <div class="mealMeta" id="mealChips"></div>
      <h1 class="mealName" id="mealName">Loading‚Ä¶</h1>

      <p class="small" id="mealHint"></p>

      <div class="controls">
        <div class="sectionTitle">Pick what applies</div>

        <div class="btnRow">
          <button class="toggleBtn" id="btnPhos">üü£ High Phosphorus</button>
          <button class="toggleBtn" id="btnK">üü° High Potassium</button>
          <button class="toggleBtn" id="btnNa">üîµ High Sodium</button>
          <button class="toggleBtn" id="btnProtein">üü¢ Good Protein Choice</button>
        </div>

        <div class="btnRow">
          <button class="toggleBtn" id="btnBinder">üíä Take Binder</button>
          <button class="danger" id="btnAvoid">üö´ Avoid this meal (sodium trap)</button>
        </div>

        <div class="btnRow">
          <button class="primary" id="btnSubmit">‚úÖ Submit</button>
          <button class="muted" id="btnNext">‚û°Ô∏è Skip / Next</button>
        </div>

        <div class="small">
          Tip: You can select multiple tags. ‚ÄúAvoid‚Äù is mainly for high-sodium meals. Binder points only apply when phosphorus is high.
        </div>
      </div>
    </div>

    <!-- Side panel -->
    <div class="sideGrid">
      <div class="card">
        <div class="sectionTitle">Session</div>
        <div class="row"><span class="small">Session score</span><b id="sessionScore">0</b></div>
        <div class="row"><span class="small">Meals answered</span><b id="answeredCount">0</b></div>
        <div class="row"><span class="small">Accuracy (tags)</span><b id="accuracy">‚Äî</b></div>
        <div class="line"></div>
        <div class="sectionTitle">Badges</div>
        <div id="badgesWrap" class="mealMeta"></div>
        <div class="line"></div>
        <div class="sectionTitle">Settings</div>

        <div class="row" style="gap:8px;">
          <label style="min-width:90px;">Nickname</label>
          <input id="nicknameInput" type="text" maxlength="14" placeholder="e.g., BinderBoss" />
        </div>
        <div class="btnRow" style="margin-top:10px;">
          <button class="muted" id="btnSaveNick">üíæ Save nickname</button>
          <button class="muted" id="btnReset">üßπ Reset progress</button>
        </div>

        <div class="line"></div>

        <div class="row">
          <label>Sound</label>
          <button class="toggleBtn" id="btnSound">üîä ON</button>
        </div>
        <div class="row">
          <label>Haptics</label>
          <button class="toggleBtn" id="btnHaptics">üì≥ ON</button>
        </div>
        <div class="row">
          <label>Learn mode</label>
          <button class="toggleBtn" id="btnLearn">üß† ON</button>
        </div>

        <p class="small" style="margin:10px 0 0 0;">
          Saved on this device (no login, no personal info). Great for dialysis-chair downtime. Badges unlock as you play.
        </p>
      </div>

      <div class="card">
        <div class="sectionTitle">How scoring works</div>
        <p class="small" style="margin:0;">
          +10 for each correctly tagged category (High Phos / High K / High Na / Good Protein).<br>
          +15 for ‚ÄúAvoid‚Äù on high-sodium meals.<br>
          +15 if binder taken when phosphorus is high.<br>
          <b>‚àí5 only if binder was needed (high phos) and you didn‚Äôt take it.</b><br>
          Binder taken when not needed: no penalty, just feedback. (We‚Äôre not training fear.)
        </p>
        <div class="line"></div>
        <p class="small" style="margin:0;">
          Feedback stays up at least <b>4 seconds</b> ‚Äî then you can tap to continue.
          Keyboard: <span class="kbd">Enter</span> submit, <span class="kbd">N</span> next.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Feedback overlay -->
<div class="feedbackOverlay" id="overlay">
  <div class="feedbackBox" role="dialog" aria-modal="true">
    <h2 class="feedbackTitle" id="fbTitle">Feedback</h2>
    <p class="feedbackText" id="fbText"></p>
    <div class="feedbackHint" id="fbHint">Hold up ‚Äî giving your brain time to read‚Ä¶</div>
  </div>
</div>

<script>
(() => {
  // ---------------------------
  // Data: realistic meal cards
  // ---------------------------
  // Labels: "high", "moderate", "low" for phos/k/na; protein: "good" or "not"
  // binderRecommended derived: phos === "high"
  const MEALS = [
    // Fast food / takeout
    {meal:"Cheeseburger + fries", phos:"high", k:"moderate", na:"high", protein:"good", note:"Fast food = sodium + phosphorus additives."},
    {meal:"Pepperoni pizza (2 slices)", phos:"high", k:"moderate", na:"high", protein:"good", note:"Cheese + processed meat = phos + sodium."},
    {meal:"Fried chicken (2 pcs) + biscuit", phos:"moderate", k:"moderate", na:"high", protein:"good", note:"Crispy/seasoned = heavy sodium."},
    {meal:"Chicken sandwich (crispy) + pickles", phos:"moderate", k:"low", na:"high", protein:"good", note:"Breading + sauces + pickles = sodium trap."},
    {meal:"Chicken sandwich (grilled)", phos:"moderate", k:"low", na:"moderate", protein:"good", note:"Often better than crispy, but still salty."},
    {meal:"Burrito bowl (rice, beans, chicken, salsa)", phos:"moderate", k:"moderate", na:"high", protein:"good", note:"Beans + salsa can push K/Na."},
    {meal:"Chinese takeout: orange chicken + rice", phos:"moderate", k:"low", na:"high", protein:"good", note:"Sauces are sodium ninjas."},
    {meal:"Ramen bowl (restaurant)", phos:"moderate", k:"low", na:"high", protein:"not", note:"Mostly sodium water. Tasty‚Ä¶ but yep."},
    {meal:"Hot dog + chips", phos:"high", k:"low", na:"high", protein:"not", note:"Processed meat = phos additives + salt."},
    {meal:"Deli turkey sandwich + cheese", phos:"high", k:"low", na:"high", protein:"good", note:"Deli meat + cheese = phos + sodium."},

    // Breakfast
    {meal:"Eggs + toast (buttered)", phos:"low", k:"low", na:"moderate", protein:"good", note:"Solid choice; watch salty toppings."},
    {meal:"Sausage biscuit", phos:"moderate", k:"low", na:"high", protein:"good", note:"Processed meat = sodium heavy."},
    {meal:"Oatmeal with banana", phos:"low", k:"high", na:"low", protein:"not", note:"Banana makes this high potassium."},
    {meal:"Pancakes + syrup + bacon", phos:"moderate", k:"low", na:"high", protein:"not", note:"Bacon does the sodium damage."},
    {meal:"Breakfast burrito (egg, cheese, sausage)", phos:"high", k:"moderate", na:"high", protein:"good", note:"Cheese/processed meat = phos + Na."},
    {meal:"Greek yogurt parfait", phos:"high", k:"low", na:"moderate", protein:"good", note:"Dairy can be high phosphorus."},
    {meal:"Bagel with cream cheese", phos:"moderate", k:"low", na:"high", protein:"not", note:"Bagels can be salty; low protein."},

    // Home-style / cultural
    {meal:"Chicken curry + naan", phos:"moderate", k:"moderate", na:"high", protein:"good", note:"Restaurant curry/naan often high sodium."},
    {meal:"Dal + rice", phos:"moderate", k:"moderate", na:"moderate", protein:"good", note:"Portion and salt matter; lentils have K/phos."},
    {meal:"Rajma chawal (kidney beans + rice)", phos:"moderate", k:"high", na:"moderate", protein:"good", note:"Beans can push potassium."},
    {meal:"Sambar + idli", phos:"low", k:"moderate", na:"moderate", protein:"not", note:"Tomato/tamarind + portion can raise K."},
    {meal:"Goat curry + rice", phos:"moderate", k:"low", na:"high", protein:"good", note:"Heavier salt/spices often = sodium."},
    {meal:"Chana masala + roti", phos:"moderate", k:"high", na:"moderate", protein:"good", note:"Chickpeas = potassium heavy."},
    {meal:"Fish curry + rice", phos:"moderate", k:"low", na:"high", protein:"good", note:"Fish is good protein; sodium varies."},
    {meal:"Home-cooked grilled chicken + rice", phos:"low", k:"low", na:"low", protein:"good", note:"Simple wins. Season smart."},
    {meal:"Paneer tikka + rice", phos:"high", k:"low", na:"high", protein:"good", note:"Dairy + restaurant salt = phos/Na."},

    // ‚ÄúHealthy-looking‚Äù traps
    {meal:"Grilled chicken Caesar salad", phos:"moderate", k:"low", na:"high", protein:"good", note:"Dressings + croutons + cheese = sodium."},
    {meal:"Protein shake (ready-to-drink)", phos:"high", k:"moderate", na:"moderate", protein:"good", note:"Many contain phosphate additives."},
    {meal:"Smoothie (banana + peanut butter)", phos:"moderate", k:"high", na:"low", protein:"good", note:"Banana spikes potassium."},
    {meal:"Avocado toast", phos:"low", k:"high", na:"moderate", protein:"not", note:"Avocado is potassium-dense."},
    {meal:"Tomato soup (canned)", phos:"low", k:"moderate", na:"high", protein:"not", note:"Canned soup = sodium missile."},
    {meal:"Frozen dinner (mac & cheese)", phos:"high", k:"low", na:"high", protein:"not", note:"Processed cheese + salt = trouble."},

    // Potassium bombs / classics
    {meal:"Banana", phos:"low", k:"high", na:"low", protein:"not", note:"Potassium heavyweight champ."},
    {meal:"Orange juice", phos:"low", k:"high", na:"low", protein:"not", note:"Liquid potassium sneaks up fast."},
    {meal:"Coconut water", phos:"low", k:"high", na:"low", protein:"not", note:"It‚Äôs basically potassium with branding."},
    {meal:"Baked potato (with skin)", phos:"low", k:"high", na:"low", protein:"not", note:"Potato = high K unless leached/prepped."},
    {meal:"Sweet potato fries", phos:"low", k:"high", na:"high", protein:"not", note:"High K + usually salty."},
    {meal:"Tomato pasta (restaurant marinara)", phos:"low", k:"moderate", na:"high", protein:"not", note:"Sauce often salty; tomato can add K."},

    // Sodium traps
    {meal:"Pickles + deli sandwich", phos:"high", k:"low", na:"high", protein:"good", note:"Pickles are basically salt cylinders."},
    {meal:"Canned chicken noodle soup", phos:"low", k:"low", na:"high", protein:"not", note:"Canned soup = sodium jackpot (bad kind)."},
    {meal:"Jerky (beef)", phos:"high", k:"moderate", na:"high", protein:"good", note:"High sodium + phos additives common."},
    {meal:"Nachos with cheese", phos:"high", k:"low", na:"high", protein:"not", note:"Cheese + chips = phos + sodium."},
    {meal:"Soy sauce stir-fry (restaurant)", phos:"low", k:"low", na:"high", protein:"good", note:"Soy sauce: the sodium boss fight."},

    // Better choices / ‚Äúwins‚Äù
    {meal:"Egg whites + peppers (home)", phos:"low", k:"moderate", na:"low", protein:"good", note:"Protein win; watch potassium portions."},
    {meal:"Tuna salad (home) + crackers", phos:"moderate", k:"low", na:"moderate", protein:"good", note:"Better at home; mayo/salt matter."},
    {meal:"Grilled fish + rice + green beans", phos:"low", k:"low", na:"low", protein:"good", note:"Simple plate = usually safer."},
    {meal:"Chicken fajitas (no beans) + tortillas", phos:"moderate", k:"low", na:"high", protein:"good", note:"Restaurant seasoning adds sodium."},
    {meal:"Steak (6 oz) + rice", phos:"moderate", k:"low", na:"moderate", protein:"good", note:"Watch portion + salty rubs."},

    // Phosphorus-heavy (binders matter)
    {meal:"Mac & cheese (restaurant)", phos:"high", k:"low", na:"high", protein:"not", note:"Cheese = phos; restaurant = sodium."},
    {meal:"Cheese platter + crackers", phos:"high", k:"low", na:"high", protein:"good", note:"Dairy is often high phosphorus."},
    {meal:"Ice cream (2 scoops)", phos:"high", k:"low", na:"low", protein:"not", note:"Dairy = phos; sweet but sneaky."},
    {meal:"Chocolate milk", phos:"high", k:"moderate", na:"moderate", protein:"good", note:"Dairy + additives can raise phos."},
    {meal:"Processed cheese slice + crackers", phos:"high", k:"low", na:"high", protein:"not", note:"Phosphate additives show up here a lot."}
  ];

  // ---------------------------
  // Persistence (localStorage)
  // ---------------------------
  const KEY = "dialysisDiner_v1";
  const defaultState = {
    nickname: "",
    totalScore: 0,
    bestStreak: 0,
    badges: [],
    settings: { sound:true, haptics:true, learn:true },
    lifetime: { answered:0, tagCorrect:0, tagTotal:0 },
    lastPlayed: ""
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      return {
        ...structuredClone(defaultState),
        ...s,
        settings: { ...structuredClone(defaultState.settings), ...(s.settings||{}) },
        lifetime: { ...structuredClone(defaultState.lifetime), ...(s.lifetime||{}) }
      };
    }catch(e){
      return structuredClone(defaultState);
    }
  }
  function saveState(){
    state.lastPlayed = new Date().toISOString().slice(0,10);
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  let state = loadState();

  // ---------------------------
  // Audio (single-file tones)
  // ---------------------------
  let audioCtx = null;
  function beep(type){
    if(!state.settings.sound) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      const now = audioCtx.currentTime;
      const presets = {
        correct: [660, 0.06],
        binder:  [520, 0.07],
        miss:    [220, 0.09],
        streak:  [880, 0.08],
        click:   [420, 0.04]
      };
      const [freq, dur] = presets[type] || presets.click;
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(now); o.stop(now + dur + 0.02);
    }catch(e){}
  }

  // ---------------------------
  // Haptics
  // ---------------------------
  function buzz(pattern){
    if(!state.settings.haptics) return;
    if(navigator.vibrate) navigator.vibrate(pattern);
  }

  // ---------------------------
  // UI refs
  // ---------------------------
  const el = id => document.getElementById(id);

  const mealName = el("mealName");
  const mealChips = el("mealChips");
  const mealHint = el("mealHint");

  const btnPhos = el("btnPhos");
  const btnK = el("btnK");
  const btnNa = el("btnNa");
  const btnProtein = el("btnProtein");
  const btnBinder = el("btnBinder");
  const btnAvoid = el("btnAvoid");
  const btnSubmit = el("btnSubmit");
  const btnNext = el("btnNext");

  const nickPill = el("nickPill");
  const totalScorePill = el("totalScorePill");
  const streakPill = el("streakPill");
  const bestStreakPill = el("bestStreakPill");

  const sessionScoreEl = el("sessionScore");
  const answeredCountEl = el("answeredCount");
  const accuracyEl = el("accuracy");
  const badgesWrap = el("badgesWrap");

  const nicknameInput = el("nicknameInput");
  const btnSaveNick = el("btnSaveNick");
  const btnReset = el("btnReset");

  const btnSound = el("btnSound");
  const btnHaptics = el("btnHaptics");
  const btnLearn = el("btnLearn");

  const overlay = el("overlay");
  const fbTitle = el("fbTitle");
  const fbText = el("fbText");
  const fbHint = el("fbHint");

  // ---------------------------
  // Game session state
  // ---------------------------
  let current = null;
  let selected = {phos:false, k:false, na:false, protein:false, binder:false, avoid:false};
  let sessionScore = 0;
  let streak = 0;
  let answered = 0;

  // Feedback gating (min 4 seconds)
  let feedbackReadyAt = 0;
  function showFeedback(title, text, vibeType){
    fbTitle.textContent = title;
    fbText.textContent = text;
    overlay.style.display = "flex";

    feedbackReadyAt = Date.now() + 4000; // minimum readable time
    fbHint.textContent = "Hold up ‚Äî giving your brain time to read‚Ä¶";

    // light sound/haptics by type
    if(vibeType === "correct"){ beep("correct"); buzz([25]); }
    else if(vibeType === "binder"){ beep("binder"); buzz([40,30,40]); }
    else if(vibeType === "miss"){ beep("miss"); buzz([90]); }
    else if(vibeType === "streak"){ beep("streak"); buzz([30,20,30,20,30]); }
    else { beep("click"); }

    // allow closing after min time
    setTimeout(() => {
      if(overlay.style.display === "flex"){
        fbHint.textContent = "Tap anywhere to continue.";
      }
    }, 4100);
  }

  function tryCloseFeedback(){
    if(Date.now() < feedbackReadyAt) return;
    overlay.style.display = "none";
    nextMeal();
  }
  overlay.addEventListener("click", tryCloseFeedback);

  // ---------------------------
  // Badge system (simple, fun)
  // ---------------------------
  function ensureBadge(name){
    if(!state.badges.includes(name)){
      state.badges.push(name);
      saveState();
      renderBadges();
      showFeedback("üèÖ Badge unlocked!", `You earned: ${name}`, "streak");
    }
  }
  function checkBadges(){
    if(state.totalScore >= 250) ensureBadge("Starter Strong");
    if(state.totalScore >= 1000) ensureBadge("Dialysis Diner Regular");
    if(state.bestStreak >= 5) ensureBadge("Streak Builder");
    if(state.bestStreak >= 10) ensureBadge("Streak Machine");
    if(state.lifetime.answered >= 50) ensureBadge("50 Meals Down");
    // Binder-related badge: track via tags + phos high binder correct occurrences (approx via points)
    // We'll unlock "Binder Boss" when total score indicates some correct binder use.
    if(state.totalScore >= 600) ensureBadge("Binder Boss");
  }

  function renderBadges(){
    badgesWrap.innerHTML = "";
    if(!state.badges.length){
      badgesWrap.innerHTML = `<span class="small">No badges yet ‚Äî start playing.</span>`;
      return;
    }
    state.badges.slice().sort().forEach(b => {
      const span = document.createElement("span");
      span.className = "badge";
      span.textContent = "üèÖ " + b;
      badgesWrap.appendChild(span);
    });
  }

  // ---------------------------
  // Utilities
  // ---------------------------
  function pickMeal(){
    // random pick; avoid immediate repeat if possible
    const idx = Math.floor(Math.random() * MEALS.length);
    return MEALS[idx];
  }
  function tagButton(btn, on){
    btn.classList.toggle("on", !!on);
  }
  function resetSelections(){
    selected = {phos:false, k:false, na:false, protein:false, binder:false, avoid:false};
    tagButton(btnPhos,false); tagButton(btnK,false); tagButton(btnNa,false); tagButton(btnProtein,false);
    tagButton(btnBinder,false);
    btnAvoid.classList.remove("on");
  }

  function truthFlags(meal){
    return {
      phos: meal.phos === "high",
      k: meal.k === "high",
      na: meal.na === "high",
      protein: meal.protein === "good",
      binderNeeded: meal.phos === "high"
    };
  }

  function updateTopUI(){
    nickPill.textContent = state.nickname ? state.nickname : "Set nickname";
    totalScorePill.textContent = state.totalScore;
    streakPill.textContent = streak;
    bestStreakPill.textContent = state.bestStreak;

    sessionScoreEl.textContent = sessionScore;
    answeredCountEl.textContent = answered;

    const total = state.lifetime.tagTotal;
    const corr = state.lifetime.tagCorrect;
    accuracyEl.textContent = total ? Math.round((corr/total)*100) + "%" : "‚Äî";

    nicknameInput.value = state.nickname || "";
    btnSound.textContent = state.settings.sound ? "üîä ON" : "üîá OFF";
    btnHaptics.textContent = state.settings.haptics ? "üì≥ ON" : "üì≥ OFF";
    btnLearn.textContent = state.settings.learn ? "üß† ON" : "üß† OFF";
    tagButton(btnSound, state.settings.sound);
    tagButton(btnHaptics, state.settings.haptics);
    tagButton(btnLearn, state.settings.learn);
  }

  function renderMeal(meal){
    mealName.textContent = meal.meal;

    const chips = [];
    // show "REALITY" chips as subtle hints (not the answers)
    if(meal.note) chips.push({text:"üçΩÔ∏è Real-world meal", cls:"chip"});
    chips.push({text:"‚è±Ô∏è Quick round", cls:"chip"});
    chips.push({text: state.settings.learn ? "üß† Learn mode" : "‚ö° Quick mode", cls: state.settings.learn ? "chip good" : "chip warn"});

    mealChips.innerHTML = chips.map(c => `<span class="${c.cls}">${c.text}</span>`).join("");

    mealHint.textContent = state.settings.learn ? (meal.note || "") : "";
  }

  // ---------------------------
  // Scoring & feedback
  // ---------------------------
  function submitAnswer(){
    if(!current) return;
    // Avoid double-submits while feedback open
    if(overlay.style.display === "flex") return;

    const truth = truthFlags(current);

    // Tag scoring (+10 each if correct selection for that tag; 0 otherwise)
    // We do NOT penalize wrong tags; we only give points for correct recognition.
    // But we track "tagTotal" for accuracy as "truth tags that should be recognized".
    const tagChecks = [
      {key:"phos", label:"High phosphorus"},
      {key:"k", label:"High potassium"},
      {key:"na", label:"High sodium"},
      {key:"protein", label:"Good protein choice"}
    ];

    let points = 0;
    let correctTags = 0;
    let totalTruthTags = 0;

    const feedbackBits = [];

    for(const t of tagChecks){
      const should = truth[t.key];
      const did = selected[t.key];

      if(should) totalTruthTags++;

      if(should && did){
        points += 10;
        correctTags++;
      }
    }

    // Avoid scoring (+15 only if sodium high and avoided)
    if(selected.avoid){
      if(truth.na){
        points += 15;
        feedbackBits.push("üö´ Avoid was smart here ‚Äî sodium trap spotted.");
      } else {
        feedbackBits.push("üö´ Avoid wasn‚Äôt necessary, but it‚Äôs okay to pass on a meal you don‚Äôt want.");
      }
    }

    // Binder logic
    if(truth.binderNeeded && selected.binder){
      points += 15;
      feedbackBits.push("üíä Binder timing was perfect.");
    } else if(truth.binderNeeded && !selected.binder){
      points -= 5;
      feedbackBits.push("üíä This meal was high phosphorus ‚Äî a binder would‚Äôve helped (‚àí5).");
    } else if(!truth.binderNeeded && selected.binder){
      // no penalty
      feedbackBits.push("üíä Binder wasn‚Äôt needed here ‚Äî no harm done üëç");
    }

    // Streak logic: streak increases if player correctly recognized at least one truth tag OR correctly avoided high Na OR correctly used binder when needed.
    // (Keeps it encouraging; not too strict.)
    const hadAWin = (correctTags > 0) || (selected.avoid && truth.na) || (truth.binderNeeded && selected.binder);
    if(hadAWin){
      streak++;
      if(streak === 5) { points += 25; feedbackBits.push("üî• 5-streak bonus: +25!"); beep("streak"); buzz([30,20,30]); }
      if(streak === 10) { points += 50; feedbackBits.push("üî• 10-streak bonus: +50!"); beep("streak"); buzz([30,20,30,20,30]); }
    } else {
      streak = 0;
    }

    // Update counters
    answered++;
    sessionScore += points;
    state.totalScore += points;
    state.bestStreak = Math.max(state.bestStreak, streak);

    // Accuracy tracking: use truth tags count (not including "protein" if it's not good? already included)
    state.lifetime.answered += 1;
    state.lifetime.tagCorrect += correctTags;
    state.lifetime.tagTotal += totalTruthTags;

    saveState();
    updateTopUI();
    checkBadges();

    // Build readable feedback (learn mode shows the ‚Äútruth‚Äù)
    const truthSummary = [];
    if(truth.phos) truthSummary.push("High Phos");
    if(truth.k) truthSummary.push("High K");
    if(truth.na) truthSummary.push("High Na");
    if(truth.protein) truthSummary.push("Good protein");

    const summaryLine = truthSummary.length ? `This meal is: ${truthSummary.join(", ")}.` : `This meal is not high in Phos/K/Na and isn‚Äôt a ‚Äúgood protein‚Äù highlight.`;

    const earnedLine = points >= 0 ? `You earned +${points} points.` : `You earned ${points} points.`;

    let title = points >= 15 ? "‚úÖ Nice work!" : (points >= 0 ? "üëç Good effort!" : "‚ö†Ô∏è Close!");
    let vibeType = points >= 15 ? "correct" : (points < 0 ? "miss" : "click");
    if(truth.binderNeeded && selected.binder) vibeType = "binder";
    if(truth.binderNeeded && !selected.binder) vibeType = "miss";

    let text = earnedLine + " " + (feedbackBits.length ? feedbackBits.join(" ") : "Keep going ‚Äî you‚Äôre building instincts.");
    if(state.settings.learn){
      text += " " + summaryLine + (current.note ? " " + current.note : "");
    }

    // Reset selections immediately so next round starts clean
    resetSelections();

    showFeedback(title, text, vibeType);
  }

  function nextMeal(){
    current = pickMeal();
    renderMeal(current);
    resetSelections();
    updateTopUI();
  }

  // ---------------------------
  // Button wiring
  // ---------------------------
  function toggle(key, btn){
    selected[key] = !selected[key];
    tagButton(btn, selected[key]);
    beep("click");
  }

  btnPhos.addEventListener("click", () => toggle("phos", btnPhos));
  btnK.addEventListener("click", () => toggle("k", btnK));
  btnNa.addEventListener("click", () => toggle("na", btnNa));
  btnProtein.addEventListener("click", () => toggle("protein", btnProtein));
  btnBinder.addEventListener("click", () => toggle("binder", btnBinder));

  btnAvoid.addEventListener("click", () => {
    selected.avoid = !selected.avoid;
    btnAvoid.classList.toggle("on", selected.avoid);
    beep("click");
  });

  btnSubmit.addEventListener("click", submitAnswer);
  btnNext.addEventListener("click", () => { beep("click"); nextMeal(); });

  // Settings toggles
  btnSound.addEventListener("click", () => {
    state.settings.sound = !state.settings.sound;
    saveState(); updateTopUI(); beep("click");
  });
  btnHaptics.addEventListener("click", () => {
    state.settings.haptics = !state.settings.haptics;
    saveState(); updateTopUI(); buzz([20]); beep("click");
  });
  btnLearn.addEventListener("click", () => {
    state.settings.learn = !state.settings.learn;
    saveState(); updateTopUI(); beep("click");
    // re-render hint visibility
    if(current) renderMeal(current);
  });

  btnSaveNick.addEventListener("click", () => {
    const raw = nicknameInput.value.trim();
    const safe = raw.replace(/[^a-zA-Z0-9_\-]/g,"").slice(0,14);
    state.nickname = safe;
    saveState();
    updateTopUI();
    showFeedback("üë§ Nickname saved", safe ? `Welcome, ${safe}. Now go bully sodium.` : "Nickname cleared.", "click");
  });

  btnReset.addEventListener("click", () => {
    if(!confirm("Reset saved progress on this device? This cannot be undone.")) return;
    localStorage.removeItem(KEY);
    state = loadState();
    sessionScore = 0; streak = 0; answered = 0;
    renderBadges();
    nextMeal();
    showFeedback("üßπ Reset complete", "Fresh start. Same kidneys, new vibes.", "click");
  });

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    if(overlay.style.display === "flex"){
      if(e.key === "Enter" || e.key.toLowerCase() === " " ) tryCloseFeedback();
      return;
    }
    if(e.key === "Enter") submitAnswer();
    if(e.key.toLowerCase() === "n") nextMeal();
  });

  // First-run nickname prompt (gentle)
  function firstRunNudge(){
    if(state.nickname) return;
    showFeedback("üëã Quick setup", "Pick a nickname on the right (optional). Your score saves automatically on this device.", "click");
  }

  // init
  renderBadges();
  nextMeal();
  firstRunNudge();
})();
</script>
</body>
</html>
