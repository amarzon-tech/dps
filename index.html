<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dialysis Diner: Plate Smart</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --muted:#93a4c7; --text:#eaf0ff;
      --accent:#5eead4; --warn:#fbbf24; --bad:#fb7185; --good:#86efac;
      --btn:#1b2a52; --btn2:#172447; --border:rgba(255,255,255,.12);
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font);
      background:radial-gradient(1200px 700px at 30% 10%, #162852 0%, var(--bg) 60%);
      color:var(--text);
    }

    /* App frame: phone-first, one screen */
    .app{
      height:100vh;
      height:100svh;
      display:flex;
      flex-direction:column;
      padding: calc(12px + var(--safeTop)) 12px calc(12px + var(--safeBottom)) 12px;
      gap:10px;
      max-width: 520px;
      margin:0 auto;
    }

    .topbar{
      border:1px solid var(--border);
      background:rgba(16,26,51,.7);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px; min-width:0}
    .brand .title{font-size:14px; font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .brand .sub{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .miniStats{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--border);
      background:rgba(9,14,28,.45);
      border-radius:999px;
      padding:6px 8px;
      font-size:11px;
      color:var(--muted);
      display:flex; gap:6px; align-items:center;
    }
    .pill b{color:var(--text); font-weight:900}

    .panel{
      flex:1;
      border:1px solid var(--border);
      background:rgba(16,26,51,.72);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      min-height:0; /* allow internal flex children to fit */
    }

    .page{display:none; flex:1; min-height:0;}
    .page.active{display:flex; flex-direction:column; gap:10px; min-height:0;}

    /* Game layout */
    .mealMeta{display:flex; gap:6px; flex-wrap:wrap}
    .chip{
      font-size:11px; padding:6px 9px; border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(9,14,28,.45);
    }
    .chip.good{color:var(--good); border-color:rgba(134,239,172,.35)}
    .chip.warn{color:var(--warn); border-color:rgba(251,191,36,.35)}

    .mealName{
      margin:6px 0 0 0;
      font-size:22px;
      font-weight:950;
      line-height:1.15;
    }
    .hint{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .controls{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:auto; /* push controls down to keep 1-screen feel */
    }

    .btnGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    button{
      appearance:none; border:1px solid var(--border); background:var(--btn);
      color:var(--text); padding:11px 10px; border-radius:16px;
      font-weight:900; cursor:pointer;
      transition: transform .06s ease, filter .12s ease, background .12s ease;
      display:flex; align-items:center; justify-content:center; gap:8px;
      font-size:12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover{filter:brightness(1.06)}
    button:active{transform:scale(.99)}
    .toggleBtn.on{outline:2px solid rgba(94,234,212,.35); background:rgba(94,234,212,.12)}
    .primary{background:linear-gradient(135deg, rgba(94,234,212,.22), rgba(94,234,212,.08)); border-color:rgba(94,234,212,.35)}
    .danger{background:linear-gradient(135deg, rgba(251,113,133,.22), rgba(251,113,133,.08)); border-color:rgba(251,113,133,.35)}
    .mutedBtn{background:var(--btn2)}
    .small{
      font-size:11px; color:var(--muted); line-height:1.35;
    }

    /* Leaderboard */
    .sectionTitle{
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:.3px;
      text-transform:uppercase;
      margin:0;
    }
    .boardHeader{
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
    }
    .boardHeader .right{ text-align:right; }
    .big{
      font-size:22px; font-weight:950; margin:2px 0 0 0;
    }
    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(9,14,28,.35);
    }
    .table th,.table td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .table th{ color:var(--muted); text-align:left; font-weight:900; }
    .table tr:last-child td{border-bottom:none}
    .meRow{ background:rgba(94,234,212,.10); }

    /* Settings */
    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(9,14,28,.45);
      color:var(--text);
      font-weight:900;
      font-size:13px;
    }
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .row label{font-size:12px; color:var(--muted); font-weight:900}
    .line{height:1px; background:var(--border); margin:8px 0}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:8px;}
    .kbd{
      font-size:11px; padding:3px 7px; border:1px solid var(--border); border-radius:8px;
      background:rgba(9,14,28,.5); color:var(--muted); font-weight:950;
    }

    /* Bottom nav */
    .nav{
      border:1px solid var(--border);
      background:rgba(16,26,51,.7);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:8px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      backdrop-filter: blur(10px);
    }
    .nav button{
      padding:10px 8px;
      font-size:12px;
      border-radius:14px;
      background:rgba(9,14,28,.35);
    }
    .nav button.active{
      background:rgba(94,234,212,.14);
      border-color:rgba(94,234,212,.35);
      outline:2px solid rgba(94,234,212,.25);
    }

    /* Feedback overlay */
    .feedbackOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:14px;
    }
    .feedbackBox{
      width:min(520px, 100%);
      border:1px solid var(--border);
      background:rgba(16,26,51,.92);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .feedbackTitle{margin:0 0 8px 0; font-size:16px; font-weight:950}
    .feedbackText{margin:0; color:var(--text); line-height:1.45; font-size:13px}
    .feedbackHint{margin-top:10px; color:var(--muted); font-size:11px}
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="title">Dialysis Diner: Plate Smart</div>
        <div class="sub" id="subline">Spot Phos/K/Na traps + binder timing</div>
      </div>
      <div class="miniStats">
        <div class="pill">üë§ <b id="nickPill">‚Äî</b></div>
        <div class="pill">‚≠ê <b id="totalScorePill">0</b></div>
        <div class="pill">üî• <b id="streakPill">0</b></div>
      </div>
    </div>

    <div class="panel">
      <!-- GAME -->
      <div class="page active" id="pageGame">
        <div class="mealMeta" id="mealChips"></div>
        <h1 class="mealName" id="mealName">Loading‚Ä¶</h1>
        <p class="hint" id="mealHint"></p>

        <div class="controls">
          <div class="btnGrid">
            <button class="toggleBtn" id="btnPhos">üü£ High Phos</button>
            <button class="toggleBtn" id="btnK">üü° High K</button>
            <button class="toggleBtn" id="btnNa">üîµ High Na</button>
            <button class="toggleBtn" id="btnProtein">üü¢ Good Protein</button>
            <button class="toggleBtn" id="btnBinder">üíä Take Binder</button>
            <button class="danger" id="btnAvoid">üö´ Avoid (Na trap)</button>
          </div>

          <div class="two">
            <button class="primary" id="btnSubmit">‚úÖ Submit</button>
            <button class="mutedBtn" id="btnNext">‚û°Ô∏è Next</button>
          </div>

          <div class="small" id="gameFooter">
            Feedback stays up at least <b>4 seconds</b>. Keyboard: <span class="kbd">Enter</span> submit, <span class="kbd">N</span> next.
          </div>
        </div>
      </div>

      <!-- LEADERBOARD -->
      <div class="page" id="pageBoard">
        <div class="boardHeader">
          <div>
            <p class="sectionTitle">Leaderboard (3-day season)</p>
            <p class="big" id="seasonTitle">Season</p>
          </div>
          <div class="right">
            <p class="sectionTitle">Resets in</p>
            <p class="big" id="resetCountdown">‚Äî</p>
          </div>
        </div>

        <div class="line"></div>

        <div class="row">
          <div class="small">Your season score</div>
          <div style="font-weight:950; font-size:16px;" id="yourSeasonScore">0</div>
        </div>

        <div class="line"></div>

        <table class="table" aria-label="Leaderboard table">
          <thead>
            <tr><th style="width:48px;">#</th><th>Nickname</th><th style="text-align:right;">Score</th></tr>
          </thead>
          <tbody id="boardBody"></tbody>
        </table>

        <div class="line"></div>

        <div class="small">
          Leaderboard is <b>shared</b> (Firebase). Nickname stays anonymous ‚Äî no login.
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="page" id="pageSettings">
        <p class="sectionTitle">Nickname (for saving + leaderboard)</p>
        <input id="nicknameInput" type="text" maxlength="14" placeholder="e.g., BinderBoss" />
        <div class="two" style="margin-top:8px;">
          <button class="mutedBtn" id="btnSaveNick">üíæ Save nickname</button>
          <button class="mutedBtn" id="btnReset">üßπ Reset progress</button>
        </div>

        <div class="line"></div>

        <p class="sectionTitle">Settings</p>
        <div class="row">
          <label>Sound</label>
          <button class="toggleBtn" id="btnSound">üîä ON</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>Haptics</label>
          <button class="toggleBtn" id="btnHaptics">üì≥ ON</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>Learn mode</label>
          <button class="toggleBtn" id="btnLearn">üß† ON</button>
        </div>

        <div class="line"></div>

        <p class="sectionTitle">Stats</p>
        <div class="row"><span class="small">Total score</span><b id="statTotal">0</b></div>
        <div class="row"><span class="small">Best streak</span><b id="statBest">0</b></div>
        <div class="row"><span class="small">Meals answered</span><b id="statAnswered">0</b></div>
        <div class="row"><span class="small">Tag accuracy</span><b id="statAcc">‚Äî</b></div>

        <div class="line"></div>

        <p class="sectionTitle">Scoring rules</p>
        <p class="small" style="margin:0;">
          +10 each for correctly tagging High Phos / High K / High Na / Good Protein.<br>
          +15 ‚ÄúAvoid‚Äù on high-sodium meals.<br>
          +15 binder when phosphorus is high.<br>
          <b>‚àí5 only if binder was needed (high phos) and you didn‚Äôt take it.</b><br>
          Binder taken when not needed: no penalty, just feedback.
        </p>
      </div>
    </div>

    <div class="nav">
      <button id="navGame" class="active">üçΩÔ∏è Game</button>
      <button id="navBoard">üèÜ Board</button>
      <button id="navSettings">‚öôÔ∏è Settings</button>
    </div>
  </div>

  <!-- Feedback overlay -->
  <div class="feedbackOverlay" id="overlay">
    <div class="feedbackBox" role="dialog" aria-modal="true">
      <h2 class="feedbackTitle" id="fbTitle">Feedback</h2>
      <p class="feedbackText" id="fbText"></p>
      <div class="feedbackHint" id="fbHint">Hold up ‚Äî giving your brain time to read‚Ä¶</div>
    </div>
  </div>

<script type="module">
// ===== Firebase (CDN imports) =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, serverTimestamp,
  collection, query, orderBy, limit, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDX56IeDLvocUKruSKC-oAeQZzgXYxkqwI",
  authDomain: "dialysis-diner.firebaseapp.com",
  projectId: "dialysis-diner",
  storageBucket: "dialysis-diner.firebasestorage.app",
  messagingSenderId: "386214391606",
  appId: "1:386214391606:web:45fe529fd5a95015b9cd97",
  measurementId: "G-VEVMGH881J"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Anonymous auth (no login UI)
signInAnonymously(auth).catch(console.error);

let currentUid = null;
onAuthStateChanged(auth, (user) => {
  if (user) currentUid = user.uid;
});

(() => {
  // ---------------------------
  // Realistic meal cards (UNCHANGED CONTENT)
  // ---------------------------
  const MEALS = [
    {meal:"Cheeseburger + fries", phos:"high", k:"moderate", na:"high", protein:"good", note:"Fast food = sodium + phosphorus additives."},
    {meal:"Pepperoni pizza (2 slices)", phos:"high", k:"moderate", na:"high", protein:"good", note:"Cheese + processed meat = phos + sodium."},
    {meal:"Fried chicken (2 pcs) + biscuit", phos:"moderate", k:"moderate", na:"high", protein:"good", note:"Crispy/seasoned = heavy sodium."},
    {meal:"Chicken sandwich (crispy) + pickles", phos:"moderate", k:"low", na:"high", protein:"good", note:"Breading + sauces + pickles = sodium trap."},
    {meal:"Chicken sandwich (grilled)", phos:"moderate", k:"low", na:"moderate", protein:"good", note:"Often better than crispy, but still salty."},
    {meal:"Burrito bowl (rice, beans, chicken, salsa)", phos:"moderate", k:"moderate", na:"high", protein:"good", note:"Beans + salsa can push K/Na."},
    {meal:"Chinese takeout: orange chicken + rice", phos:"moderate", k:"low", na:"high", protein:"good", note:"Sauces are sodium ninjas."},
    {meal:"Ramen bowl (restaurant)", phos:"moderate", k:"low", na:"high", protein:"not", note:"Mostly sodium water. Tasty‚Ä¶ but yep."},
    {meal:"Hot dog + chips", phos:"high", k:"low", na:"high", protein:"not", note:"Processed meat = phos additives + salt."},
    {meal:"Deli turkey sandwich + cheese", phos:"high", k:"low", na:"high", protein:"good", note:"Deli meat + cheese = phos + sodium."},

    {meal:"Eggs + toast (buttered)", phos:"low", k:"low", na:"moderate", protein:"good", note:"Solid choice; watch salty toppings."},
    {meal:"Sausage biscuit", phos:"moderate", k:"low", na:"high", protein:"good", note:"Processed meat = sodium heavy."},
    {meal:"Oatmeal with banana", phos:"low", k:"high", na:"low", protein:"not", note:"Banana makes this high potassium."},
    {meal:"Pancakes + syrup + bacon", phos:"moderate", k:"low", na:"high", protein:"not", note:"Bacon does the sodium damage."},
    {meal:"Breakfast burrito (egg, cheese, sausage)", phos:"high", k:"moderate", na:"high", protein:"good", note:"Cheese/processed meat = phos + Na."},
    {meal:"Greek yogurt parfait", phos:"high", k:"low", na:"moderate", protein:"good", note:"Dairy can be high phosphorus."},
    {meal:"Bagel with cream cheese", phos:"moderate", k:"low", na:"high", protein:"not", note:"Bagels can be salty; low protein."},

    {meal:"Chicken curry + naan", phos:"moderate", k:"moderate", na:"high", protein:"good", note:"Restaurant curry/naan often high sodium."},
    {meal:"Dal + rice", phos:"moderate", k:"moderate", na:"moderate", protein:"good", note:"Portion and salt matter; lentils have K/phos."},
    {meal:"Rajma chawal (kidney beans + rice)", phos:"moderate", k:"high", na:"moderate", protein:"good", note:"Beans can push potassium."},
    {meal:"Sambar + idli", phos:"low", k:"moderate", na:"moderate", protein:"not", note:"Tomato/tamarind + portion can raise K."},
    {meal:"Goat curry + rice", phos:"moderate", k:"low", na:"high", protein:"good", note:"Heavier salt/spices often = sodium."},
    {meal:"Chana masala + roti", phos:"moderate", k:"high", na:"moderate", protein:"good", note:"Chickpeas = potassium heavy."},
    {meal:"Fish curry + rice", phos:"moderate", k:"low", na:"high", protein:"good", note:"Fish is good protein; sodium varies."},
    {meal:"Home-cooked grilled chicken + rice", phos:"low", k:"low", na:"low", protein:"good", note:"Simple wins. Season smart."},
    {meal:"Paneer tikka + rice", phos:"high", k:"low", na:"high", protein:"good", note:"Dairy + restaurant salt = phos/Na."},

    {meal:"Grilled chicken Caesar salad", phos:"moderate", k:"low", na:"high", protein:"good", note:"Dressings + croutons + cheese = sodium."},
    {meal:"Protein shake (ready-to-drink)", phos:"high", k:"moderate", na:"moderate", protein:"good", note:"Many contain phosphate additives."},
    {meal:"Smoothie (banana + peanut butter)", phos:"moderate", k:"high", na:"low", protein:"good", note:"Banana spikes potassium."},
    {meal:"Avocado toast", phos:"low", k:"high", na:"moderate", protein:"not", note:"Avocado is potassium-dense."},
    {meal:"Tomato soup (canned)", phos:"low", k:"moderate", na:"high", protein:"not", note:"Canned soup = sodium missile."},
    {meal:"Frozen dinner (mac & cheese)", phos:"high", k:"low", na:"high", protein:"not", note:"Processed cheese + salt = trouble."},

    {meal:"Banana", phos:"low", k:"high", na:"low", protein:"not", note:"Potassium heavyweight champ."},
    {meal:"Orange juice", phos:"low", k:"high", na:"low", protein:"not", note:"Liquid potassium sneaks up fast."},
    {meal:"Coconut water", phos:"low", k:"high", na:"low", protein:"not", note:"It‚Äôs basically potassium with branding."},
    {meal:"Baked potato (with skin)", phos:"low", k:"high", na:"low", protein:"not", note:"Potato = high K unless leached/prepped."},
    {meal:"Sweet potato fries", phos:"low", k:"high", na:"high", protein:"not", note:"High K + usually salty."},
    {meal:"Tomato pasta (restaurant marinara)", phos:"low", k:"moderate", na:"high", protein:"not", note:"Sauce often salty; tomato can add K."},

    {meal:"Pickles + deli sandwich", phos:"high", k:"low", na:"high", protein:"good", note:"Pickles are basically salt cylinders."},
    {meal:"Canned chicken noodle soup", phos:"low", k:"low", na:"high", protein:"not", note:"Canned soup = sodium jackpot (bad kind)."},
    {meal:"Jerky (beef)", phos:"high", k:"moderate", na:"high", protein:"good", note:"High sodium + phos additives common."},
    {meal:"Nachos with cheese", phos:"high", k:"low", na:"high", protein:"not", note:"Cheese + chips = phos + sodium."},
    {meal:"Soy sauce stir-fry (restaurant)", phos:"low", k:"low", na:"high", protein:"good", note:"Soy sauce: the sodium boss fight."},

    {meal:"Egg whites + peppers (home)", phos:"low", k:"moderate", na:"low", protein:"good", note:"Protein win; watch potassium portions."},
    {meal:"Tuna salad (home) + crackers", phos:"moderate", k:"low", na:"moderate", protein:"good", note:"Better at home; mayo/salt matter."},
    {meal:"Grilled fish + rice + green beans", phos:"low", k:"low", na:"low", protein:"good", note:"Simple plate = usually safer."},
    {meal:"Chicken fajitas (no beans) + tortillas", phos:"moderate", k:"low", na:"high", protein:"good", note:"Restaurant seasoning adds sodium."},
    {meal:"Steak (6 oz) + rice", phos:"moderate", k:"low", na:"moderate", protein:"good", note:"Watch portion + salty rubs."},

    {meal:"Mac & cheese (restaurant)", phos:"high", k:"low", na:"high", protein:"not", note:"Cheese = phos; restaurant = sodium."},
    {meal:"Cheese platter + crackers", phos:"high", k:"low", na:"high", protein:"good", note:"Dairy is often high phosphorus."},
    {meal:"Ice cream (2 scoops)", phos:"high", k:"low", na:"low", protein:"not", note:"Dairy = phos; sweet but sneaky."},
    {meal:"Chocolate milk", phos:"high", k:"moderate", na:"moderate", protein:"good", note:"Dairy + additives can raise phos."},
    {meal:"Processed cheese slice + crackers", phos:"high", k:"low", na:"high", protein:"not", note:"Phosphate additives show up here a lot."}
  ];

  // ---------------------------
  // Persistence
  // ---------------------------
  const KEY = "dialysisDiner_phone_v1";
  const defaultState = {
    nickname: "",
    totalScore: 0,
    bestStreak: 0,
    settings: { sound:true, haptics:true, learn:true },
    lifetime: { answered:0, tagCorrect:0, tagTotal:0 },
    // Leaderboard (local device) w/ 3-day seasons
    leaderboard: {
      seasonId: null,
      seasonStartMs: null,
      yourSeasonScore: 0,
      entries: [] // {name, score}
    }
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      return {
        ...structuredClone(defaultState),
        ...s,
        settings: { ...structuredClone(defaultState.settings), ...(s.settings||{}) },
        lifetime: { ...structuredClone(defaultState.lifetime), ...(s.lifetime||{}) },
        leaderboard: { ...structuredClone(defaultState.leaderboard), ...(s.leaderboard||{}) }
      };
    }catch(e){
      return structuredClone(defaultState);
    }
  }
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  let state = loadState();

  // ---------------------------
  // 3-day season logic
  // ---------------------------
  const SEASON_DAYS = 3;
  const MS_DAY = 24*60*60*1000;

  function getSeasonId(nowMs){
    // anchor to Unix epoch; every 3 days is a season
    return Math.floor(nowMs / (SEASON_DAYS * MS_DAY));
  }
  function ensureSeason(){
    const now = Date.now();
    const sid = getSeasonId(now);
    if(state.leaderboard.seasonId !== sid){
      // reset season
      state.leaderboard.seasonId = sid;
      state.leaderboard.seasonStartMs = sid * SEASON_DAYS * MS_DAY;
      state.leaderboard.yourSeasonScore = 0;
      state.leaderboard.entries = [];
      saveState();
    }
  }
  function msUntilSeasonReset(){
    ensureSeason();
    const start = state.leaderboard.seasonStartMs ?? (getSeasonId(Date.now()) * SEASON_DAYS * MS_DAY);
    const end = start + SEASON_DAYS * MS_DAY;
    return Math.max(0, end - Date.now());
  }
  function formatCountdown(ms){
    const s = Math.floor(ms/1000);
    const d = Math.floor(s/86400);
    const h = Math.floor((s%86400)/3600);
    const m = Math.floor((s%3600)/60);
    return d>0 ? `${d}d ${h}h` : `${h}h ${m}m`;
  }

  // ---------------------------
  // Audio (single-file tones)
  // ---------------------------
  let audioCtx = null;
  function beep(type){
    if(!state.settings.sound) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      const now = audioCtx.currentTime;
      const presets = {
        correct: [660, 0.06],
        binder:  [520, 0.07],
        miss:    [220, 0.09],
        streak:  [880, 0.08],
        click:   [420, 0.04]
      };
      const [freq, dur] = presets[type] || presets.click;
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(now); o.stop(now + dur + 0.02);
    }catch(e){}
  }

  // ---------------------------
  // Haptics
  // ---------------------------
  function buzz(pattern){
    if(!state.settings.haptics) return;
    if(navigator.vibrate) navigator.vibrate(pattern);
  }

  // ---------------------------
  // UI refs
  // ---------------------------
  const el = id => document.getElementById(id);

  const nickPill = el("nickPill");
  const totalScorePill = el("totalScorePill");
  const streakPill = el("streakPill");
  const subline = el("subline");

  // Pages & nav
  const pageGame = el("pageGame");
  const pageBoard = el("pageBoard");
  const pageSettings = el("pageSettings");
  const navGame = el("navGame");
  const navBoard = el("navBoard");
  const navSettings = el("navSettings");

  // Game
  const mealChips = el("mealChips");
  const mealName = el("mealName");
  const mealHint = el("mealHint");

  const btnPhos = el("btnPhos");
  const btnK = el("btnK");
  const btnNa = el("btnNa");
  const btnProtein = el("btnProtein");
  const btnBinder = el("btnBinder");
  const btnAvoid = el("btnAvoid");
  const btnSubmit = el("btnSubmit");
  const btnNext = el("btnNext");

  // Leaderboard
  const seasonTitle = el("seasonTitle");
  const resetCountdown = el("resetCountdown");
  const yourSeasonScore = el("yourSeasonScore");
  const boardBody = el("boardBody");

  // Settings
  const nicknameInput = el("nicknameInput");
  const btnSaveNick = el("btnSaveNick");
  const btnReset = el("btnReset");
  const btnSound = el("btnSound");
  const btnHaptics = el("btnHaptics");
  const btnLearn = el("btnLearn");

  const statTotal = el("statTotal");
  const statBest = el("statBest");
  const statAnswered = el("statAnswered");
  const statAcc = el("statAcc");

  // Feedback overlay
  const overlay = el("overlay");
  const fbTitle = el("fbTitle");
  const fbText = el("fbText");
  const fbHint = el("fbHint");

  // ---------------------------
  // Game session state
  // ---------------------------
  let current = null;
  let selected = {phos:false, k:false, na:false, protein:false, binder:false, avoid:false};
  let streak = 0;

  // Feedback gating (min 4 seconds)
  let feedbackReadyAt = 0;
  function showFeedback(title, text, vibeType){
    fbTitle.textContent = title;
    fbText.textContent = text;
    overlay.style.display = "flex";

    feedbackReadyAt = Date.now() + 4000;
    fbHint.textContent = "Hold up ‚Äî giving your brain time to read‚Ä¶";

    if(vibeType === "correct"){ beep("correct"); buzz([25]); }
    else if(vibeType === "binder"){ beep("binder"); buzz([40,30,40]); }
    else if(vibeType === "miss"){ beep("miss"); buzz([90]); }
    else if(vibeType === "streak"){ beep("streak"); buzz([30,20,30,20,30]); }
    else { beep("click"); }

    setTimeout(() => {
      if(overlay.style.display === "flex"){
        fbHint.textContent = "Tap anywhere to continue.";
      }
    }, 4100);
  }
  function tryCloseFeedback(){
    if(Date.now() < feedbackReadyAt) return;
    overlay.style.display = "none";
    nextMeal();
  }
  overlay.addEventListener("click", tryCloseFeedback);

  // ---------------------------
  // Helpers
  // ---------------------------
  function tagButton(btn, on){ btn.classList.toggle("on", !!on); }
  function resetSelections(){
    selected = {phos:false, k:false, na:false, protein:false, binder:false, avoid:false};
    tagButton(btnPhos,false); tagButton(btnK,false); tagButton(btnNa,false); tagButton(btnProtein,false);
    tagButton(btnBinder,false);
    btnAvoid.classList.remove("on");
  }
  function pickMeal(){
    const idx = Math.floor(Math.random() * MEALS.length);
    return MEALS[idx];
  }
  function truthFlags(meal){
    return {
      phos: meal.phos === "high",
      k: meal.k === "high",
      na: meal.na === "high",
      protein: meal.protein === "good",
      binderNeeded: meal.phos === "high"
    };
  }

  function renderMeal(meal){
    const chips = [];
    chips.push({text:"‚è±Ô∏è Quick", cls:"chip"});
    chips.push({text: state.settings.learn ? "üß† Learn" : "‚ö° Fast", cls: state.settings.learn ? "chip good" : "chip warn"});
    mealChips.innerHTML = chips.map(c => `<span class="${c.cls}">${c.text}</span>`).join("");

    mealName.textContent = meal.meal;
    mealHint.textContent = state.settings.learn ? (meal.note || "") : "";
  }

    // ---------------------------
  // Leaderboard functions (Firebase, 3-day season)
  // ---------------------------
  let unsubLeaderboard = null;
  let latestRows = [];

  function seasonIdStr(){
    // Use your existing season math (same reset behavior) but as a string for Firestore paths
    return String(getSeasonId(Date.now()));
  }

  function subscribeSeasonLeaderboard(){
    const sid = seasonIdStr();
    const scoresRef = collection(db, `seasons/${sid}/scores`);
    const q = query(scoresRef, orderBy("score", "desc"), limit(20));

    if (unsubLeaderboard) unsubLeaderboard();
    unsubLeaderboard = onSnapshot(q, (snap) => {
      latestRows = snap.docs.map(d => d.data());
      renderLeaderboard();
    }, (err) => {
      console.error(err);
    });
  }

  async function pushMySeasonScore(){
    if (!currentUid || !state.nickname) return;
    const sid = seasonIdStr();
    const ref = doc(db, `seasons/${sid}/scores/${currentUid}`);
    await setDoc(ref, {
      uid: currentUid,
      nickname: state.nickname,
      score: Math.trunc(state.leaderboard.yourSeasonScore),
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  function renderLeaderboard(){
    ensureSeason();

    const sid = seasonIdStr();
    seasonTitle.textContent = `Season #${sid}`;
    yourSeasonScore.textContent = state.leaderboard.yourSeasonScore;

    const rows = latestRows || [];
    boardBody.innerHTML = "";

    if(rows.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" style="color:var(--muted); padding:14px;">No scores yet. Play a round and check back.</td>`;
      boardBody.appendChild(tr);
      return;
    }

    rows.forEach((e, i) => {
      const tr = document.createElement("tr");
      const n = (e.nickname || "").toString();
      const isMe = state.nickname && n.toLowerCase() === state.nickname.toLowerCase();
      if(isMe) tr.classList.add("meRow");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(n || "‚Äî")}</td>
        <td style="text-align:right; font-weight:950;">${(e.score ?? 0)}</td>
      `;
      boardBody.appendChild(tr);
    });
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  // Countdown timer
  function tickCountdown(){
    resetCountdown.textContent = formatCountdown(msUntilSeasonReset());
  }

  // ---------------------------
  // Top UI / Settings stats
  // ---------------------------
  function updateUI(){
    ensureSeason();
    nickPill.textContent = state.nickname ? state.nickname : "Set nickname";
    totalScorePill.textContent = state.totalScore;
    streakPill.textContent = streak;

    nicknameInput.value = state.nickname || "";

    btnSound.textContent = state.settings.sound ? "üîä ON" : "üîá OFF";
    btnHaptics.textContent = state.settings.haptics ? "üì≥ ON" : "üö´ OFF";
    btnLearn.textContent = state.settings.learn ? "üß† ON" : "üß† OFF";
    tagButton(btnSound, state.settings.sound);
    tagButton(btnHaptics, state.settings.haptics);
    tagButton(btnLearn, state.settings.learn);

    statTotal.textContent = state.totalScore;
    statBest.textContent = state.bestStreak;
    statAnswered.textContent = state.lifetime.answered;

    const total = state.lifetime.tagTotal;
    const corr = state.lifetime.tagCorrect;
    statAcc.textContent = total ? (Math.round((corr/total)*100) + "%") : "‚Äî";

    subline.textContent = state.settings.learn
      ? "Learn mode: shows short explanations"
      : "Fast mode: no hints, just instincts";
  }

  // ---------------------------
  // Scoring (same logic, fits phone)
  // ---------------------------
  function submitAnswer(){
    if(!current) return;
    if(overlay.style.display === "flex") return;

    ensureSeason();

    const truth = truthFlags(current);
    const tagChecks = [
      {key:"phos", label:"High phosphorus"},
      {key:"k", label:"High potassium"},
      {key:"na", label:"High sodium"},
      {key:"protein", label:"Good protein choice"}
    ];

    let points = 0;
    let correctTags = 0;
    let totalTruthTags = 0;
    const feedbackBits = [];

    for(const t of tagChecks){
      const should = truth[t.key];
      const did = selected[t.key];
      if(should) totalTruthTags++;
      if(should && did){
        points += 10;
        correctTags++;
      }
    }

    // Avoid scoring (+15 only if sodium high and avoided)
    if(selected.avoid){
      if(truth.na){
        points += 15;
        feedbackBits.push("üö´ Avoid was smart ‚Äî sodium trap spotted.");
      } else {
        feedbackBits.push("üö´ Avoid wasn‚Äôt necessary, but it‚Äôs okay to pass.");
      }
    }

    // Binder logic (your rule)
    if(truth.binderNeeded && selected.binder){
      points += 15;
      feedbackBits.push("üíä Binder timing was perfect.");
    } else if(truth.binderNeeded && !selected.binder){
      points -= 5;
      feedbackBits.push("üíä High phosphorus meal ‚Äî binder would‚Äôve helped (‚àí5).");
    } else if(!truth.binderNeeded && selected.binder){
      feedbackBits.push("üíä Binder wasn‚Äôt needed ‚Äî no harm done üëç");
    }

    // Streak logic (encouraging)
    const hadAWin = (correctTags > 0) || (selected.avoid && truth.na) || (truth.binderNeeded && selected.binder);
    if(hadAWin){
      streak++;
      if(streak === 5) { points += 25; feedbackBits.push("üî• 5-streak bonus: +25!"); beep("streak"); buzz([30,20,30]); }
      if(streak === 10) { points += 50; feedbackBits.push("üî• 10-streak bonus: +50!"); beep("streak"); buzz([30,20,30,20,30]); }
    } else {
      streak = 0;
    }

    // Apply scores
    state.totalScore += points;
    state.bestStreak = Math.max(state.bestStreak, streak);

    // Season score increments (can be negative, but leaderboard uses max)
    state.leaderboard.yourSeasonScore += points;

    // Push to shared Firebase leaderboard (if nickname set)
    if(state.nickname){
      pushMySeasonScore().catch(console.error);
    }

    // Accuracy stats
    state.lifetime.answered += 1;
    state.lifetime.tagCorrect += correctTags;
    state.lifetime.tagTotal += totalTruthTags;

    // Save + update leaderboard if nickname exists
    if(state.nickname){
      pushMySeasonScore().catch(console.error);
    }

    saveState();
    updateUI();

    // Feedback build
    const truthSummary = [];
    if(truth.phos) truthSummary.push("High Phos");
    if(truth.k) truthSummary.push("High K");
    if(truth.na) truthSummary.push("High Na");
    if(truth.protein) truthSummary.push("Good protein");

    const summaryLine = truthSummary.length
      ? `This meal is: ${truthSummary.join(", ")}.`
      : `This meal is not high in Phos/K/Na and isn‚Äôt a ‚Äúgood protein‚Äù highlight.`;

    const earnedLine = points >= 0 ? `You earned +${points} points.` : `You earned ${points} points.`;

    let title = points >= 15 ? "‚úÖ Nice work!" : (points >= 0 ? "üëç Good effort!" : "‚ö†Ô∏è Close!");
    let vibeType = points >= 15 ? "correct" : (points < 0 ? "miss" : "click");
    if(truth.binderNeeded && selected.binder) vibeType = "binder";
    if(truth.binderNeeded && !selected.binder) vibeType = "miss";

    let text = earnedLine + " " + (feedbackBits.length ? feedbackBits.join(" ") : "Keep going ‚Äî you‚Äôre building instincts.");
    if(state.settings.learn){
      text += " " + summaryLine + (current.note ? " " + current.note : "");
    }

    resetSelections();
    showFeedback(title, text, vibeType);

    // Update board page data if they‚Äôre looking at it
    renderLeaderboard();
  }

  function nextMeal(){
    current = pickMeal();
    renderMeal(current);
    resetSelections();
    updateUI();
  }

  // ---------------------------
  // Navigation
  // ---------------------------
  function showPage(which){
    [pageGame,pageBoard,pageSettings].forEach(p => p.classList.remove("active"));
    [navGame,navBoard,navSettings].forEach(b => b.classList.remove("active"));

    if(which === "game"){ pageGame.classList.add("active"); navGame.classList.add("active"); }
    if(which === "board"){ pageBoard.classList.add("active"); navBoard.classList.add("active"); subscribeSeasonLeaderboard(); renderLeaderboard(); }
    if(which === "settings"){ pageSettings.classList.add("active"); navSettings.classList.add("active"); }

    beep("click");
  }

  navGame.addEventListener("click", () => showPage("game"));
  navBoard.addEventListener("click", () => showPage("board"));
  navSettings.addEventListener("click", () => showPage("settings"));

  // ---------------------------
  // Button wiring
  // ---------------------------
  function toggle(key, btn){
    selected[key] = !selected[key];
    tagButton(btn, selected[key]);
    beep("click");
  }
  btnPhos.addEventListener("click", () => toggle("phos", btnPhos));
  btnK.addEventListener("click", () => toggle("k", btnK));
  btnNa.addEventListener("click", () => toggle("na", btnNa));
  btnProtein.addEventListener("click", () => toggle("protein", btnProtein));
  btnBinder.addEventListener("click", () => toggle("binder", btnBinder));

  btnAvoid.addEventListener("click", () => {
    selected.avoid = !selected.avoid;
    btnAvoid.classList.toggle("on", selected.avoid);
    beep("click");
  });

  btnSubmit.addEventListener("click", submitAnswer);
  btnNext.addEventListener("click", () => { beep("click"); nextMeal(); });

  // Settings toggles
  btnSound.addEventListener("click", () => {
    state.settings.sound = !state.settings.sound;
    saveState(); updateUI(); beep("click");
  });
  btnHaptics.addEventListener("click", () => {
    state.settings.haptics = !state.settings.haptics;
    saveState(); updateUI(); buzz([20]); beep("click");
  });
  btnLearn.addEventListener("click", () => {
    state.settings.learn = !state.settings.learn;
    saveState(); updateUI(); beep("click");
    if(current) renderMeal(current);
  });

  btnSaveNick.addEventListener("click", () => {
    const raw = nicknameInput.value.trim();
    const safe = raw.replace(/[^a-zA-Z0-9_\-]/g,"").slice(0,14);
    state.nickname = safe;
    saveState();
    updateUI();
    if(state.nickname){
      // create/update leaderboard entry immediately
      ensureSeason();
      pushMySeasonScore().catch(console.error);
      renderLeaderboard();
      showFeedback("üë§ Nickname saved", `Welcome, ${state.nickname}. Now go bully sodium.`, "correct");
    } else {
      showFeedback("üë§ Nickname cleared", "You can still play ‚Äî leaderboard needs a nickname though.", "click");
    }
  });

  btnReset.addEventListener("click", () => {
    if(!confirm("Reset saved progress on this device? This cannot be undone.")) return;
    localStorage.removeItem(KEY);
    state = loadState();
    streak = 0;
    ensureSeason();
    nextMeal();
    renderLeaderboard();
    showFeedback("üßπ Reset complete", "Fresh start. Same kidneys, new vibes.", "click");
  });

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    if(overlay.style.display === "flex"){
      if(e.key === "Enter" || e.key === " ") tryCloseFeedback();
      return;
    }
    if(e.key === "Enter") submitAnswer();
    if(e.key.toLowerCase() === "n") nextMeal();
  });

  // ---------------------------
  // Init
  // ---------------------------
  function firstRunNudge(){
    if(state.nickname) return;
    showFeedback("üëã Quick setup", "Pick a nickname in Settings (optional). Scores save automatically. Leaderboard needs a nickname.", "click");
  }

  ensureSeason();
  nextMeal();
  renderLeaderboard();
  tickCountdown();
  setInterval(() => { tickCountdown(); ensureSeason(); }, 1000 * 30); // refresh every 30s
  firstRunNudge();
})();
</script>
</body>
</html>
